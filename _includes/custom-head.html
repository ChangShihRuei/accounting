<script>
  const WEB_APP_URL =
    'https://script.google.com/macros/s/AKfycbxd_aHlwcWnxNjD-f20kpobPOT_6YtrfaPmKSbgHTMHjUL0TPONXptzw5ngD1MsQFaFPQ/exec';
  let LAST_DATA = null;
  let IS_EDIT_MODE = true;

  // 等待 DOM 載入完成後執行
  document.addEventListener('DOMContentLoaded', function() {
    fetchData();
  });

  async function sendSectionUpdate(sectionTitle, headers, rows) {
    // 後端需支援 action:updateSection，依 sectionTitle 決定更新哪個工作表或區塊
    const payload = {
      action: 'updateSection',
      section: sectionTitle,
      headers,
      rows,
    };
    const resp = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload),
    });
    if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
    return resp.json();
  }

  function fetchData() {
    const container = document.getElementById('data-container');
    if (!container) {
      console.error('找不到 data-container 元素');
      return;
    }

    // 顯示載入中訊息
    container.innerHTML = '<p>正在載入記帳資料...</p>';

    fetch(WEB_APP_URL)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((result) => {
        console.log('收到的資料:', result);
        
        if (result && result.data) {
          LAST_DATA = result.data;
          displayAccountingData(LAST_DATA);
        } else {
          throw new Error('資料格式不正確');
        }
      })
      .catch((error) => {
        console.error('載入資料時發生錯誤:', error);
        container.innerHTML = `
          <div style="color: red; padding: 10px; background-color: #ffe6e6; border-radius: 5px;">
            <h3>載入失敗</h3>
            <p>無法載入記帳資料，請稍後再試。</p>
            <p>錯誤訊息: ${error.message}</p>
          </div>
        `;
      });
  }

  function displayAccountingData(data) {
    const container = document.getElementById('data-container');
    if (!container) return;

    container.innerHTML = ''; // 清除載入中訊息

    // 創建主要標題
    const mainTitle = document.createElement('h1');
    mainTitle.textContent = '記帳資料總覽';
    mainTitle.style.textAlign = 'center';
    mainTitle.style.marginBottom = '30px';
    mainTitle.style.color = '#2c3e50';
    container.appendChild(mainTitle);

    // 永遠編輯模式：不顯示切換工具列

    // 顯示當月收入
    if (data['當月收入'] && data['當月收入'].length > 0) {
      displaySection(container, '當月收入', data['當月收入'], 'income');
    }

    // 顯示當月支出
    if (data['當月支出預算'] && data['當月支出預算'].length > 0) {
      displaySection(container, '當月支出預算', data['當月支出預算'], 'expense');
    }

    // 顯示隔月預計支出
    if (data['隔月預計支出'] && data['隔月預計支出'].length > 0) {
      displaySection(container, '隔月預計支出', data['隔月預計支出'], 'future');
    }

    // 顯示當月支出細項
    if (data['當月實際支出細項'] && data['當月實際支出細項'].length > 0) {
      displayTransactionDetails(container, '當月實際支出細項', data['當月實際支出細項']);
    }
  }

  function displaySection(container, title, items, type) {
    const section = document.createElement('div');
    section.className = 'accounting-section';
    section.style.marginBottom = '30px';
    section.style.padding = '20px';
    section.style.borderRadius = '8px';
    section.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';

    // 根據類型設定背景色
    if (type === 'income') {
      section.style.backgroundColor = '#e8f5e8';
      section.style.borderLeft = '4px solid #27ae60';
    } else if (type === 'expense') {
      section.style.backgroundColor = '#ffeaea';
      section.style.borderLeft = '4px solid #e74c3c';
    } else {
      section.style.backgroundColor = '#f0f8ff';
      section.style.borderLeft = '4px solid #3498db';
    }

    // 創建可收合標題
    const sectionTitle = document.createElement('h2');
    sectionTitle.textContent = title + ' ▼';
    sectionTitle.style.marginBottom = '15px';
    sectionTitle.style.color = '#2c3e50';
    sectionTitle.style.cursor = 'pointer';
    sectionTitle.setAttribute('tabindex', '0');
    sectionTitle.setAttribute('role', 'button');
    sectionTitle.setAttribute('aria-expanded', 'true');
    section.appendChild(sectionTitle);

    // 創建內容容器
    const contentDiv = document.createElement('div');
    contentDiv.style.display = 'block';

    // 區塊控制列（僅編輯模式顯示）
    const controlsDiv = document.createElement('div');
    controlsDiv.style.display = IS_EDIT_MODE ? 'flex' : 'none';
    controlsDiv.style.gap = '8px';
    controlsDiv.style.margin = '8px 0 12px 0';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = '儲存此區塊';
    saveBtn.style.padding = '6px 10px';
    saveBtn.style.border = '1px solid #27ae60';
    saveBtn.style.background = '#e8f8f0';
    saveBtn.style.borderRadius = '6px';
    saveBtn.style.cursor = 'pointer';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = '取消變更';
    cancelBtn.style.padding = '6px 10px';
    cancelBtn.style.border = '1px solid #aaa';
    cancelBtn.style.background = '#f1f1f1';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.cursor = 'pointer';

    controlsDiv.appendChild(saveBtn);
    controlsDiv.appendChild(cancelBtn);
    contentDiv.appendChild(controlsDiv);

    // 創建表格
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';
    table.style.tableLayout = 'auto'; // 讓表格自動調整欄位寬度

    // 創建表頭
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = Object.keys(items[0] || {});
    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      th.style.padding = '12px 15px';
      th.style.textAlign = 'left';
      th.style.borderBottom = '2px solid #ddd';
      th.style.backgroundColor = '#f8f9fa';
      th.style.whiteSpace = 'nowrap'; // 防止標題換行
      th.style.minWidth = '80px'; // 最小寬度
      // 根據欄位內容設定寬度
      if (header.includes('金額') || header.includes('預算') || header.includes('實際消費金額')) {
        th.style.width = '120px';
        th.style.textAlign = 'right';
      } else if (header.includes('項目')) {
        th.style.width = '200px';
      } else if (header.includes('細節') || header.includes('備註')) {
        th.style.width = '300px';
        th.style.whiteSpace = 'normal'; // 允許換行
        th.style.wordWrap = 'break-word';
      } else if (header.includes('日期')) {
        th.style.width = '120px';
      } else if (header.includes('類別')) {
        th.style.width = '250px';
      } else if (header.includes('方式')) {
        th.style.width = '150px';
      } else {
        th.style.width = 'auto';
      }
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // 創建表格內容
    const tbody = document.createElement('tbody');
    items.forEach((item, index) => {
      const row = document.createElement('tr');
      row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
      headers.forEach(header => {
        const td = document.createElement('td');
        td.textContent = item[header] || '';
        td.style.padding = '10px 15px';
        td.style.borderBottom = '1px solid #ddd';
        td.style.verticalAlign = 'top';
        if (IS_EDIT_MODE) {
          td.contentEditable = 'true';
          td.style.outline = '1px dashed rgba(0,0,0,0.2)';
          td.style.backgroundColor = 'rgba(255,255,0,0.06)';
        }
        // 根據欄位類型設定樣式
        if (header.includes('金額') || header.includes('預算') || header.includes('實際消費金額')) {
          td.style.fontWeight = 'bold';
          td.style.textAlign = 'right';
          td.style.fontFamily = 'monospace';
          if (type === 'income') {
            td.style.color = '#27ae60';
          } else if (type === 'expense') {
            td.style.color = '#e74c3c';
          }
        } else if (header.includes('細節') || header.includes('備註')) {
          td.style.whiteSpace = 'normal';
          td.style.wordWrap = 'break-word';
          td.style.maxWidth = '300px';
          td.style.lineHeight = '1.4';
        } else if (header.includes('項目')) {
          td.style.fontWeight = '500';
          td.style.color = '#2c3e50';
        } else if (header.includes('日期')) {
          td.style.fontFamily = 'monospace';
          td.style.color = '#7f8c8d';
        } else if (header.includes('類別')) {
          td.style.color = '#34495e';
          td.style.fontSize = '0.95em';
        } else if (header.includes('方式')) {
          td.style.color = '#7f8c8d';
          td.style.fontSize = '0.9em';
        }
        row.appendChild(td);
      });
      tbody.appendChild(row);
    });
    table.appendChild(tbody);

    // tfoot 總計列（自動加總、不可編輯）
    const tfoot = document.createElement('tfoot');
    const totalRow = document.createElement('tr');
    headers.forEach((header, i) => {
      const td = document.createElement('td');
      td.style.padding = '10px 15px';
      td.style.borderTop = '2px solid #aaa';
      td.style.fontWeight = 'bold';
      if (i === 0) {
        td.textContent = '總計';
      } else if (header.includes('金額') || header.includes('預算') || header.includes('實際消費金額')) {
        td.style.textAlign = 'right';
        td.style.fontFamily = 'monospace';
        td.dataset.totalFor = header;
      } else {
        td.textContent = '';
      }
      totalRow.appendChild(td);
    });
    tfoot.appendChild(totalRow);
    table.appendChild(tfoot);

    // 計算總計的函式
    function recalcTotals() {
      headers.forEach((header) => {
        if (header.includes('金額') || header.includes('預算') || header.includes('實際消費金額')) {
          let sum = 0;
          Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
            const idx = headers.indexOf(header);
            const cell = tr.children[idx];
            const num = parseFloat((cell?.innerText || '').replace(/[^\d.-]/g, '')) || 0;
            sum += num;
          });
          const totalCell = totalRow.children[headers.indexOf(header)];
          if (totalCell) totalCell.textContent = sum.toLocaleString();
        }
      });
    }

    // 首次計算 + 編輯即時更新
    setTimeout(recalcTotals, 0);
    tbody.addEventListener('input', recalcTotals);
    contentDiv.appendChild(table);
    section.appendChild(contentDiv);
    container.appendChild(section);

    // 事件：儲存/取消（僅編輯模式）
    cancelBtn.addEventListener('click', () => {
      displayAccountingData(LAST_DATA || data);
    });

    saveBtn.addEventListener('click', async () => {
      // 從表格讀回資料
      const newRows = [];
      const bodyRows = Array.from(tbody.querySelectorAll('tr'));
      bodyRows.forEach((tr) => {
        const obj = {};
        const cells = Array.from(tr.querySelectorAll('td'));
        headers.forEach((h, i) => {
          obj[h] = (cells[i]?.innerText || '').trim();
        });
        newRows.push(obj);
      });

      saveBtn.disabled = true;
      saveBtn.textContent = '儲存中...';
      try {
        const resp = await sendSectionUpdate(title, headers, newRows);
        if (resp && resp.data) {
          LAST_DATA = resp.data;
        }
        // 重新渲染
        displayAccountingData(LAST_DATA || data);
        alert('已儲存成功');
      } catch (e) {
        console.error(e);
        alert('儲存失敗：' + (e?.message || '未知錯誤'));
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '儲存此區塊';
      }
    });

    // 收合/展開功能
    sectionTitle.addEventListener('click', function() {
      if (contentDiv.style.display === 'none') {
        contentDiv.style.display = 'block';
        sectionTitle.textContent = title + ' ▼';
        sectionTitle.setAttribute('aria-expanded', 'true');
      } else {
        contentDiv.style.display = 'none';
        sectionTitle.textContent = title + ' ▲';
        sectionTitle.setAttribute('aria-expanded', 'false');
      }
    });
    sectionTitle.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        sectionTitle.click();
      }
    });
  }

  function displayTransactionDetails(container, title, transactions) {
    const section = document.createElement('div');
    section.className = 'transaction-section';
    section.style.marginBottom = '30px';
    section.style.padding = '20px';
    section.style.backgroundColor = '#f9f9f9';
    section.style.borderRadius = '8px';
    section.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
    section.style.borderLeft = '4px solid #9b59b6';

    // 創建可收合標題
    const sectionTitle = document.createElement('h2');
    sectionTitle.textContent = title + ' ▼';
    sectionTitle.style.marginBottom = '15px';
    sectionTitle.style.color = '#2c3e50';
    sectionTitle.style.cursor = 'pointer';
    sectionTitle.setAttribute('tabindex', '0');
    sectionTitle.setAttribute('role', 'button');
    sectionTitle.setAttribute('aria-expanded', 'true');
    section.appendChild(sectionTitle);

    // 內容容器
    const contentDiv = document.createElement('div');
    contentDiv.style.display = 'block';

    // 區塊控制列（僅編輯模式顯示）
    const controlsDiv = document.createElement('div');
    controlsDiv.style.display = IS_EDIT_MODE ? 'flex' : 'none';
    controlsDiv.style.gap = '8px';
    controlsDiv.style.margin = '8px 0 12px 0';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = '儲存此區塊';
    saveBtn.style.padding = '6px 10px';
    saveBtn.style.border = '1px solid #27ae60';
    saveBtn.style.background = '#e8f8f0';
    saveBtn.style.borderRadius = '6px';
    saveBtn.style.cursor = 'pointer';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = '取消變更';
    cancelBtn.style.padding = '6px 10px';
    cancelBtn.style.border = '1px solid #aaa';
    cancelBtn.style.background = '#f1f1f1';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.cursor = 'pointer';

    controlsDiv.appendChild(saveBtn);
    controlsDiv.appendChild(cancelBtn);
    contentDiv.appendChild(controlsDiv);

    // 創建統計資訊
    const totalAmount = transactions.reduce((sum, t) => sum + (parseFloat(t['實際消費金額']) || 0), 0);
    const statsDiv = document.createElement('div');
    statsDiv.style.marginBottom = '15px';
    statsDiv.style.padding = '10px';
    statsDiv.style.backgroundColor = '#ffffff';
    statsDiv.style.borderRadius = '5px';
    statsDiv.innerHTML = `
      <strong>總交易筆數:</strong> ${transactions.length} 筆 | 
      <strong>總支出金額:</strong> <span style="color: #e74c3c; font-weight: bold;">${totalAmount.toLocaleString()} 元</span>
    `;
    contentDiv.appendChild(statsDiv);

    // 創建交易列表
    const transactionList = document.createElement('div');
    transactions.forEach((transaction) => {
      const transactionDiv = document.createElement('div');
      transactionDiv.style.backgroundColor = '#ffffff';
      transactionDiv.style.marginBottom = '10px';
      transactionDiv.style.padding = '15px';
      transactionDiv.style.borderRadius = '5px';
      transactionDiv.style.borderLeft = '3px solid #9b59b6';
      transactionDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

      // 標題列（項目與金額）
      const titleRow = document.createElement('div');
      titleRow.style.display = 'flex';
      titleRow.style.justifyContent = 'space-between';
      titleRow.style.alignItems = 'center';
      titleRow.style.marginBottom = '5px';

      const nameEl = document.createElement('strong');
      nameEl.style.color = '#2c3e50';
      nameEl.textContent = transaction['交易項目'] || '';
      if (IS_EDIT_MODE) nameEl.contentEditable = 'true';

      const amountEl = document.createElement('span');
      amountEl.style.color = '#e74c3c';
      amountEl.style.fontWeight = 'bold';
      amountEl.style.fontSize = '1.1em';
      const amountNumber = parseFloat(transaction['實際消費金額'] || 0) || 0;
      amountEl.textContent = IS_EDIT_MODE ? String(amountNumber) : `${amountNumber.toLocaleString()} 元`;
      if (IS_EDIT_MODE) amountEl.contentEditable = 'true';

      titleRow.appendChild(nameEl);
      titleRow.appendChild(amountEl);

      // 資訊列（日期、類別、支付、備註）
      const metaRow = document.createElement('div');
      metaRow.style.color = '#7f8c8d';
      metaRow.style.fontSize = '0.9em';

      const dateEl = document.createElement('span');
      const originalDate = transaction['交易日期'] || '';
      if (IS_EDIT_MODE) {
        dateEl.textContent = originalDate;
        dateEl.contentEditable = 'true';
      } else {
        const date = originalDate ? new Date(originalDate) : null;
        const formattedDate = date && !isNaN(date) ? date.toLocaleDateString('zh-TW') : originalDate;
        dateEl.textContent = `📅 ${formattedDate}`;
      }

      const catEl = document.createElement('span');
      catEl.textContent = IS_EDIT_MODE ? (transaction['消費類別'] || '') : `🏷️ ${transaction['消費類別'] || ''}`;
      if (IS_EDIT_MODE) catEl.contentEditable = 'true';

      const payEl = document.createElement('span');
      payEl.textContent = IS_EDIT_MODE ? (transaction['支付方式'] || '') : `💳 ${transaction['支付方式'] || ''}`;
      if (IS_EDIT_MODE) payEl.contentEditable = 'true';

      const noteEl = document.createElement('span');
      noteEl.textContent = IS_EDIT_MODE ? (transaction['備註'] || '') : (transaction['備註'] ? `📝 ${transaction['備註']}` : '');
      if (IS_EDIT_MODE) noteEl.contentEditable = 'true';

      // 組裝 metaRow，加入分隔符號
      metaRow.appendChild(dateEl);
      if (!IS_EDIT_MODE) metaRow.appendChild(document.createTextNode(' | '));
      metaRow.appendChild(catEl);
      if (!IS_EDIT_MODE) metaRow.appendChild(document.createTextNode(' | '));
      metaRow.appendChild(payEl);
      if (!IS_EDIT_MODE) metaRow.appendChild(document.createTextNode(' | '));
      if (noteEl.textContent !== '' || IS_EDIT_MODE) {
        metaRow.appendChild(noteEl);
      }

      transactionDiv.appendChild(titleRow);
      transactionDiv.appendChild(metaRow);

      transactionList.appendChild(transactionDiv);
    });
    contentDiv.appendChild(transactionList);
    section.appendChild(contentDiv);
    container.appendChild(section);

    // 事件：儲存/取消（僅編輯模式）
    cancelBtn.addEventListener('click', () => {
      displayAccountingData(LAST_DATA);
    });

    saveBtn.addEventListener('click', async () => {
      // 讀回資料
      const newRows = [];
      const cards = Array.from(transactionList.children);
      cards.forEach((card) => {
        const strong = card.querySelector('strong');
        const spans = card.querySelectorAll('span');
        // spans: amountEl + others; 因為我們有多個 span，需精確抓取
        const name = strong?.innerText?.trim() || '';
        const amountText = spans[0]?.innerText?.trim() || '0';
        // 接著是 dateEl, catEl, payEl, noteEl（可能不存在）
        const dateText = spans[1]?.innerText?.replace(/^📅\s*/, '').trim() || spans[1]?.innerText?.trim() || '';
        const cat = spans[2]?.innerText?.replace(/^🏷️\s*/, '').trim() || spans[2]?.innerText?.trim() || '';
        const pay = spans[3]?.innerText?.replace(/^💳\s*/, '').trim() || spans[3]?.innerText?.trim() || '';
        const note = (spans[4]?.innerText || '').replace(/^📝\s*/, '').trim();
        newRows.push({
          '交易日期': dateText,
          '交易項目': name,
          '消費類別': cat,
          '支付方式': pay,
          '實際消費金額': amountText,
          '備註': note,
        });
      });

      saveBtn.disabled = true;
      saveBtn.textContent = '儲存中...';
      try {
        const headers = ['交易日期','交易項目','消費類別','支付方式','實際消費金額','備註'];
        const resp = await sendSectionUpdate(title, headers, newRows);
        if (resp && resp.data) {
          LAST_DATA = resp.data;
        }
        displayAccountingData(LAST_DATA);
        alert('已儲存成功');
      } catch (e) {
        console.error(e);
        alert('儲存失敗：' + (e?.message || '未知錯誤'));
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '儲存此區塊';
      }
    });

    // 收合/展開功能
    sectionTitle.addEventListener('click', function() {
      if (contentDiv.style.display === 'none') {
        contentDiv.style.display = 'block';
        sectionTitle.textContent = title + ' ▼';
        sectionTitle.setAttribute('aria-expanded', 'true');
      } else {
        contentDiv.style.display = 'none';
        sectionTitle.textContent = title + ' ▲';
        sectionTitle.setAttribute('aria-expanded', 'false');
      }
    });
    sectionTitle.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        sectionTitle.click();
      }
    });
  }
</script>